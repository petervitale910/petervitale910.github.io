---
title: "San Fransisco Bay Catch Dynamics"
description: "Examining Northern Anchovies ability to predict indicator species"
date: 2025-12-3
categories: [MEDS, R, Statistics]
citation: 
  url: https://petervitale910.github.io/
image: image.jpg
code-fold: true
toc: true
bibliography: references.bib
---

![@Wooldridge2020_silhouette_bridge_sunset](image.jpg)

The San Francisco Bay is a large estuarine bay in Northern California which spans 60 miles [@Britannica_SanFranciscoBay]. The San Francisco Estuary is the largest estuary in California, with rivers from the ridgeline of the Sierra Nevada mountains leading to the strait of the Golden Gate, including almost 60,000 square miles and nearly 40% of California [@SFEP_AboutEstuary]. As of 2002, San Francisco Bay sustains nearly 500 species of fish, invertebrates, birds, mammals, insects and amphibians. It is an essential resting place, feeding area, and wintering ground for millions of birds on the Pacific Flyway. Nearly half of the state's waterfowl and shorebirds and two-third of the state's salmon pass through the Bay during their migrations [@BCDC_2002_SF_Bay_Ecology].

In recent years harmful algal blooms (HABs) have decimated many populations in the bay. HABs are becoming more frequent and more intense across California as waters warm. Decreased flows from inland rivers and streams, and increased concentrations of nutrients and other land-based pollutants additionally exacerbate the growth of algae and cyanotoxins [@OPC_HarmfulAlgalBloom2022].

When monitoring the bay, it is often difficult to monitor less populated species to the extent of more frequent species. To combat this in this project I will be comparing populations of Northern Anchovy, the most populous species in the bay, to that of other more niche species.

### DAG

This analysis is predicated on the same environmental factors effecting Northern Anchovies and other species at similar levels. This leads to a DAG which looks like this:

```{r, fig.width=11, fig.height=8}
dag <- dagitty::dagitty('dag {
bb="0,0,1,1"
"Bay Region" [pos="0.375,0.496"]
"Environmental Variables (EG. Toxic algal bloom)" [pos="0.378,0.222"]
"Northern Anchovy Population" [pos="0.277,0.343"]
"Indicator Sp Population" [pos="0.495,0.341"]
"Bay Region" -> "Environmental Variables (EG. Toxic algal bloom)"
"Bay Region" -> "Northern Anchovy Population"
"Bay Region" -> "Indicator Sp Population"
"Environmental Variables (EG. Toxic algal bloom)" -> "Northern Anchovy Population"
"Environmental Variables (EG. Toxic algal bloom)" -> "Indicator Sp Population"
}')

par(mar = c(5,5,5,5))
plot(dagitty::graphLayout(dag))
```

### Import packages

```{r}
pacman::p_load('tidyverse', 
               'here',
               'janitor',
               'indicspecies',
               'MASS',
               'ggthemes',
               'stargazer',
               'broom',
               'knitr',
               'kableExtra')
```

### Import and clean data

First we import data which was requested from [@MSI_SF_Bay_Institute]

```{r, warning=FALSE, message=FALSE}
# Raw catch data
catch_raw <- read_csv(here::here('posts', 'sf_bay_catches', 'data', 'catch_9218.csv'))

# For easy reference we also import species key 
species_key <- read_csv(here::here('posts', 'sf_bay_catches','data', 'species_key.csv'), col_names = FALSE)
```

Now we can clean up the messy dataset and make a functional species key

```{r}
# The species key has some very difficult first columns so we need to restrict it down to just species code and name
species_key_clean <- species_key[c(4,5),3:125] %>% 
  row_to_names(row_number = 1) %>% 
  clean_names() %>% 
  remove_empty(which = "rows") %>% 
  pivot_longer(cols = everything(),names_to = 'species_code', values_to = 'species_name')%>% 
  mutate(species_code = str_to_upper(species_code),
                                     species_name = str_to_title(str_to_lower(species_name)))

species_key_clean
```

```{r}
# The catch data is much cleaner, all we need is a quick clean names
catch_clean <- catch_raw %>% 
  clean_names()

catch_clean$species_code[is.na(catch_clean$species_code)] <- 'NA'

head(catch_clean)
```

### Preliminary analysis: Top Species

We want to display the top 10 species caught by quantity to see what species we are catching most

```{r}
top_10_catch <- catch_clean %>%
  left_join(species_key_clean,
            by = "species_code") %>%
  group_by(species_name) %>%
  summarise(total_catch = sum(number, na.rm = TRUE)) %>%
  arrange(desc(total_catch)) %>%
  slice_head(n = 10) 

top_10_catch %>% 
rename('Species Name' = species_name,
             'Total Catch' = total_catch) %>%  
kable( format = "html", digits = 3,
      caption = "Top 10 Species Caught in the SF Bay") %>% 
  kable_styling(
    bootstrap_options = c("striped", "hover", "condensed", "responsive"),
    full_width = FALSE,
    position   = "center",
    font_size  = 14
  ) %>% 
  row_spec(0, bold = TRUE, color = "white", background = "#A0185A") %>%  # header
  row_spec(1:nrow(top_10_catch), color = "black", background = "#FFC4EB")
```

In this analysis we will take the most abundant species, Northern Anchovy, and compare it with indicator species from the different regions of the bay.

### Preliminary analysis: Indicator species

Indicator species:

-   reflect the biotic or abiotic state of the environment;

-   provide evidence for the impacts of environmental change; or

-   predict the diversity of other species, taxa or communities within an area.

By comparing Anchovy population to that of indicator species, it may shed light on whether Anchovy population can be representative of the indicator. 

To perform the indicator species analysis we will be using the function `multipatt` from the package `indispecies`. The function takes a group *vector* and a species *matrix*

```{r}
indicator <- catch_clean %>% 
  dplyr::select(catch_info_trawl_id, species_code, number, locale) %>% 
  pivot_wider(names_from = species_code, values_from = number, values_fn = sum) %>% 
  mutate(across(where(is.numeric), ~replace_na(., 0))) %>% 
  filter(!locale == 'BLANK')

group_vector <- indicator$locale

species_matrix <- as.matrix(indicator[, -c(1, 2)])

```

Now we can run the function `multipatt` to find indicator species values for our groups

```{r}
indval <- multipatt(species_matrix, group_vector, 
                    control = how(nperm=999)) 
```

```{r}
 summary <- summary(indval, alpha = .1) # Alpha is significance threshold 
```

From the summary we can see that the top species for the four San Francisco Bay locales are:

Group CENTRAL BAY
SSD: Speckled Sanddab

Group SAN PABLO BAY
BR: Bat Ray

Group SOUTH BAY
CT: California Tonguefish

Group SUISUN BAY
SB: Striped Bass

Next we are going to compare Northern Anchovy catches to these species using a hurdle model

### Hurdle model and create function
Hurdle Models are a class of models for count data that help handle excess zeros and overdispersion, which fits our data to a T. It handles these by treating presence as a binary operator (present vs not present) and running a binomial(link = 'logit') model. The model also includes abundance, which analyzes count data using a negative binomial model. 

Presence:
$$
\begin{align}
\text{Presence} &\sim Binomial(1, p) \\
logit(p) &= \beta_0 + \beta_1 \text{NorthernAnchovyZ}* \beta_2 \text{inregion}
\end{align}
$$
Abundance:
$$
\begin{align}
\text{Presence} &\sim NegBin(\lambda, \theta) \\
log(\lambda) &= \beta_0 + \beta_1 \text{NorthernAnchovyZ}* \beta_2 \text{inregion}
\end{align}
$$
We use the z-score transformed count of Northern Anchovy as it:

-  Helps with numerical stability, especially in interaction terms
-  Is useful when comparing effect sizes across variables on different scales


Because we are running and fitting this model four times, it sounds like I should make it into a function

### Function 
```{r}
#' predict indicator
#'
#' @param df
#' Data frame used for analysis
#' @param sp_code 
#' Species code (wrapped in '')
#' @param region 
#' Locale (all capitals wrapped in '')
#' @returns
#' a list containing: 
#' stage1_summary 
#' stage2_summary 
#' stage1_pred 
#' stage2_pred
#' combined_pred 
#' plot 
#' @export
#'
#' @examples
predict_indicator <- function(df, sp_code, region) {

  species_name <- species_key_clean %>% 
    filter(species_code == sp_code) %>% 
    pull(species_name) %>% 
    make_clean_names()

  catch_plot <- df %>% 
    filter(species_code == 'NA' | species_code == sp_code) %>% 
    mutate(in_region = ifelse(locale == region, TRUE, FALSE)) %>% 
    group_by(species_code, catch_info_trawl_id, in_region) %>% 
    summarize(count = sum(number), .groups = "drop") %>% 
    pivot_wider(names_from = species_code,
                values_from = count) %>% 
    set_names(c('trawl_id', 'in_region', 'northern_anchovy', species_name)) 

  catch_plot[is.na(catch_plot)] <- 0

  a <- mean(catch_plot$northern_anchovy)
  b <- sd(catch_plot$northern_anchovy)

  catch_plot <- catch_plot %>% 
    mutate(
      northern_anchovy_z = (northern_anchovy - a) / b,
      presence = ifelse(.data[[species_name]] > 0, 1, 0),
      abundance = ifelse(.data[[species_name]] > 0, .data[[species_name]], NA)
    )

  # Stage 1 & 2 models
  m1 <- glm(presence ~ northern_anchovy_z * in_region, data = catch_plot, family = binomial(link = 'logit'))
  m2 <- glm.nb(abundance ~ northern_anchovy_z * in_region, data = catch_plot)

  # Tidy outputs
  m1_tidy <- tidy(m1) %>% mutate(model = "Presence (Logit)")
  m2_tidy <- tidy(m2) %>% mutate(model = "Abundance (NegBin)")

  all_models <- bind_rows(m1_tidy, m2_tidy) %>%
    dplyr::select(model, term, estimate, std.error, statistic, p.value) %>%
    rename(
      Model = model,
      Term = term,
      Estimate = estimate,
      SE = std.error,
      'Test Stat' = statistic,
      'P-Value' = p.value
    )

  # Styled kable for model summary
  summary_table <- all_models %>% 
    kable(format = "html", digits = 3, caption = "Joint Model Output: Presence vs Abundance") %>% 
    kable_styling(
      bootstrap_options = c("striped", "hover", "condensed", "responsive"),
      full_width = FALSE,
      position = "center",
      font_size = 14
    ) %>% 
    row_spec(0, bold = TRUE, color = "white", background = "#A0185A") %>% 
    row_spec(1:nrow(all_models), color = "black", background = "#FFC4EB")

  # Prediction grid
  grid_data <- expand_grid(
    in_region = c(TRUE, FALSE),
    northern_anchovy_z = seq(min(catch_plot$northern_anchovy_z), max(catch_plot$northern_anchovy_z), by = 1)
  )

  # Predictions
  predict_pres <- predict(m1, newdata = grid_data, type = "link", se.fit = TRUE)
  predict_abu  <- predict(m2, newdata = grid_data, type = "link", se.fit = TRUE)

  pred_pres_result <- grid_data %>% 
    mutate(
      fit_link = predict_pres$fit,
      se = predict_pres$se.fit,
      pred_tbs = plogis(fit_link),
      lower = plogis(fit_link - 1.96*se),
      upper = plogis(fit_link + 1.96*se)
    )

  pred_abu_result <- grid_data %>% 
    mutate(
      fit_link = predict_abu$fit,
      se = predict_abu$se.fit,
      pred_tbs = exp(fit_link),
      lower = exp(fit_link - 1.96*se),
      upper = exp(fit_link + 1.96*se)
    )

  # Merge predictions
  combined_pred <- pred_pres_result %>% 
    mutate(
      expected_count = pred_tbs * pred_abu_result$pred_tbs,
      lower_expected = lower * pred_abu_result$lower,
      upper_expected = upper * pred_abu_result$upper
    )

  # Styled kables for predictions
  pred_pres_table <- pred_pres_result %>% 
    kable(format = "html", digits = 3, caption = "Presence Predictions") %>% 
    kable_styling(
      bootstrap_options = c("striped", "hover", "condensed", "responsive"),
      full_width = FALSE,
      position = "center",
      font_size = 14
    ) %>% 
    row_spec(0, bold = TRUE, color = "white", background = "#A0185A") %>% 
    row_spec(1:nrow(pred_pres_result), color = "black", background = "#FFC4EB") %>% 
    scroll_box(width = "800px", height = "300px")

  pred_abu_table <- pred_abu_result %>% 
    kable(format = "html", digits = 3, caption = "Abundance Predictions") %>% 
    kable_styling(
      bootstrap_options = c("striped", "hover", "condensed", "responsive"),
      full_width = FALSE,
      position = "center",
      font_size = 14
    ) %>% 
    row_spec(0, bold = TRUE, color = "white", background = "#A0185A") %>% 
    row_spec(1:nrow(pred_abu_result), color = "black", background = "#FFC4EB") %>% 
    scroll_box(width = "800px", height = "300px")

  combined_table <- combined_pred %>% 
    kable(format = "html", digits = 3, caption = "Expected Counts (Presence × Abundance)") %>% 
    kable_styling(
      bootstrap_options = c("striped", "hover", "condensed", "responsive"),
      full_width = FALSE,
      position = "center",
      font_size = 14
    ) %>% 
    row_spec(0, bold = TRUE, color = "white", background = "#A0185A") %>% 
    row_spec(1:nrow(combined_pred), color = "black", background = "#FFC4EB") %>% 
    scroll_box(width = "800px", height = "300px")

  # Plot
  plot <- ggplot(combined_pred, aes(northern_anchovy_z, expected_count)) +
    facet_wrap(~in_region,
               labeller = as_labeller(c(`TRUE` = "In Region", `FALSE` = "Outside Region"))) +
    geom_line(color = '#A0185A') +
    geom_ribbon(aes(ymin = lower_expected, ymax = upper_expected),
                alpha = .3, fill = '#ABC798') +
    labs(x = 'Northern Anchovy Z',
         y = str_to_title(str_replace_all(species_name, "_", " "))) +
    theme_clean()

  return(list(
    summary_table = summary_table,
    pred_pres_table = pred_pres_table,
    pred_abu_table = pred_abu_table,
    combined_table = combined_table,
    stage1_pred = pred_pres_result,
    stage2_pred = pred_abu_result,
    combined_pred = combined_pred,
    plot = plot
  ))
}

```

### Simulate data

Before we use this model we will be simulating data in an attempt to see if the model is appropriate for our data.

```{r}
set.seed(42)

n_sim <- 1000

# Predictor: standardized anchovy index
northern_anchovy_z <- rnorm(n_sim, mean = 0, sd = 1)

# in_region alternates TRUE / FALSE / TRUE / FALSE ...
in_region <- rep(c(TRUE, FALSE), length.out = n_sim)

# Logistic (presence/absence)
beta0_presence <- -.5
beta1_presence <-  1.2

# Abundance (given present)
beta0_abundance <- 0.7
beta1_abundance <- 0.4

theta <- 1.8  # NB dispersion

# Probability of presence
p_presence <- plogis(beta0_presence + beta1_presence * northern_anchovy_z)

# Storage
presence  <- rep(0, n_sim)
abundance <- rep(0, n_sim)

for (i in 1:n_sim){

  presence[i] <- rbinom(1, 1, p_presence[i])

  if(presence[i] == 1){

    lambda_i <- exp(beta0_abundance + beta1_abundance * northern_anchovy_z[i])

    # truncated NB — no zeros allowed
    repeat {
      y <- rnbinom(1, mu = lambda_i, size = theta)
      if(y > 0){
        abundance[i] <- y
        break
      }
    }
  }
}

sim_data <- tibble(
  northern_anchovy_z,
  in_region,
  presence,
  abundance
)

```

### Simulated Data model

To make sure the model returns the coefficients from the simulated data we can run our model on the dataframe of the model

#### Model Simulated data

```{r}
m1 <- glm(presence ~ northern_anchovy_z * in_region, 
          data = sim_data, 
          family = binomial(link = 'logit'))

m2 <- glm.nb(abundance ~ northern_anchovy_z * in_region, 
             data = sim_data)

m1_tidy <- tidy(m1)%>% 
  mutate(model = "Presence (Logit)")
m2_tidy <- tidy(m2)%>% 
  mutate(model = "Abundance (NegBin)")

# combine and format
all_models <- bind_rows(m1_tidy, m2_tidy) %>%
  dplyr::select(model, term, estimate, std.error, statistic, p.value)%>%
  rename(
    Model = model,
    Term = term,
    Estimate = estimate,
    SE = std.error,
    'Test Stat' = statistic,
    'P-Value'   = p.value
  ) 

kable(all_models, format = "html", digits = 3,
      caption = "Joint Model Output: Presence vs Abundance")%>%
  kable_styling(
    bootstrap_options = c("striped", "hover", "condensed", "responsive"),
    full_width = FALSE,
    position   = "center",
    font_size  = 14
  ) %>% 
  row_spec(0, bold = TRUE, color = "white", background = "#A0185A") %>%  # header
  row_spec(1:nrow(all_models), color = "black", background = "#FFC4EB")  # body rows

```

### Function Call: Central Bay

The top indicator for the Central Bay was the Speckled Sanddab so we can call the function for that species and region

```{r}
speckled <- predict_indicator(catch_clean, 'SSD', 'CENTRAL BAY')
```

Now `speckled` is encoded with our model summaries, predictions, and plot. For this I will show all outputs, in later chunks I will bypass showing predictions

#### Model Summary

```{r}
speckled$summary_table
```

#### Presence Prediction

```{r}
speckled$pred_pres_table
```

#### Abundance Prediction

```{r}
speckled$pred_abu_table
```

#### Combined Prediction

```{r}
speckled$combined_table
```

#### Speckled plot

```{r}
speckled$plot
```

#### Discussion: Speckled Sanddab
Based on the function we can see significance in presence of Anchovy and the region in both presence and abundance. This indicates that the presence of Anchovy comes at the cost of presence of Sanddabs. This model does not seem to fit incredibly well when looking at the plot, which can be seen by the flat lines and giant confidence intervals. 

### Function Call: San Pablo Bay

```{r}
bat_ray <- predict_indicator(catch_clean, 'BR', 'SAN PABLO BAY')
```

#### Model Summary

```{r}
bat_ray$summary_table
```

#### Bat Ray Plot

```{r}
bat_ray$plot
```

#### Discussion: Bat Ray
Based on the summary table, we can see significance of both presence and abundance in relation to Northern Anchovy. Interestingly the presence is barely insignificant while abundance is significant in region, indicating that this species is an indicator based more on abundance. 

### Function Call: South Bay

```{r}
ca_tonguefish <- predict_indicator(catch_clean, 'CT', 'SOUTH BAY')
```

#### Model Summary

```{r}
ca_tonguefish$summary_table
```

#### Tonguefish Plot

```{r}
ca_tonguefish$plot
```

#### Discussion: California Tonguefish
In my opinion this is the most interesting interaction. Presence in region, based on Northern Anchovy, *and* the interaction between the two are all significant. This is the only case in the analysis where any interaction is significant. When looking at abundance, both Anchovies and the interaction between them and `in_region` are minimally insignificant. When looking at the plot we see the best looking curve in the plot of within region. All this is super interesting in the context that in recent years there have been very few catches of Tonguefish, which indicates some sort of temporal skew. 

### Function Call: Suisun Bay

```{r}
bass <- predict_indicator(catch_clean, 'SB', 'SUISUN BAY')
```

#### Presence Summary

```{r}
bass$summary_table
```

#### Bass Plot

```{r}
bass$plot
```

#### Discussion: Striped Bass
If Tonguefish was our best model, this would be our worst. When fitting the model we get the warning: prediction from rank-deficient fit; attr(*, "non-estim") has doubtful cases. This indicates that the function is having trouble fitting the model to this data. This means that the summary and plot end up being generally unreliable. This was a big surprise to me as I expected Striped Bass to show an intense correlation, as they like less salty water when they pass through the bay (as infants and juveniles). 

### Final Discussion
Despite the effort, this analysis indicates that there is no real correlation between these indicator species and Northern Anchovy populations. In the future it may be possible to fit specific models to specific fish, and alter the models based on the fish species. Furthermore the integration of actual water quality variables such as temperature and salinity may yield more significance and representation within the data. 
